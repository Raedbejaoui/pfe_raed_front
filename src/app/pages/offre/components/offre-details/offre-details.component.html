
<!-- Start Breadcrumbs -->
<app-breadcrumbs title="Appel D'offre Détails" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>

<!-- End Breadcrumbs -->

<div class="row g-0">
  <div class="col-xxl-4">
    <!-- Left Column with Image Slider -->
    <div class="card p-3 sticky-side-div">
      <div class="product-img-slider">
        <ngx-slick-carousel class="carousel swiper product-thumbnail-slider p-2 rounded bg-light custom-arrow" [config]="slideConfig" #slickModal="slick-carousel" (afterChange)="slickChange($event)">
          <div ngxSlickItem *ngFor="let imageUrl of offerDetails?.images; let i = index" class="slide">
            <div class="p-5 mx-4">
              <img [src]="sanitizer.bypassSecurityTrustUrl(imageUrl)" alt="" class="img-fluid d-block">
            </div>
          </div>
        </ngx-slick-carousel>

        <ngx-slick-carousel class="carousel swiper product-nav-slider mt-2" [config]="slidesConfig">
          <div ngxSlickItem *ngFor="let imageUrl of offerDetails?.images; let i = index" class="swiper-slide swiperlist me-2" (click)="slidePreview(i,$event)">
            <div class="nav-slide-item">
              <img [src]="sanitizer.bypassSecurityTrustUrl(imageUrl)" alt="" class="img-fluid d-block">
            </div>
          </div>
        </ngx-slick-carousel>
      </div>
      <!-- End Image Slider -->
    </div>
  </div>

  <div class="col-xxl-8">
    <!-- Right Column with Offer Details -->
    <div class="card rounded-end-0">
      <div class="card-body p-4">
        <p class="text-muted float-md-end mb-md-0"><a href="javascript:void(0);"><i class="ph-storefront align-middle me-1"></i> Offre</a></p>
        <h4 class="text-capitalize mb-3">{{ offerDetails?.title }}</h4>
        <div class="hstack gap-3 flex-wrap mb-4">
          <div class="text-muted">Date de création : <b class="text-body fw-medium">{{ formatDate(offerDetails?.creationDate) }}</b></div>
          <div class="vr"></div>
        </div>

        <div>
          <h5 class="fs-md mb-3">Description :</h5>
          <p class="text-muted mb-2">{{ offerDetails?.description }}</p>
        </div>

<div class="deadline-highlight">
  <span>Deadline est: </span>
  <button type="button" class="btn btn-secondary">{{ formatDate(offerDetails?.deadline) }}</button>
</div>
        <div class="status-highlight mt-4">
          <h5 class="fs-md mb-3">Etat de l'offre:</h5>
          <td [ngClass]="{
            'status-en-cours': offerDetails?.offerStatus === 'EN_COURS',
            'text-success': offerDetails?.offerStatus === 'ACCEPTED',
            'text-danger': offerDetails?.offerStatus === 'rejected'
          }">{{ offerDetails?.offerStatus }}</td>
        </div>

        <div class="mt-4">
          <!-- Buttons -->
          <div class="d-flex justify-content-end">
            <div *ngIf="isCurrentUserOwner()">
              <button type="button" class="btn btn-custom me-3" (click)="editOffer(offerDetails)">Modifier ton appel d'Offre</button>
              <button type="button" class="btn btn-custom1" (click)="confirmDelete()"><i class="ph-trash align-middle me-1"></i>Supprimer</button>
            </div>
            <div *ngIf="isEnterpriseUser()">
              <button type="button" class="btn btn-primary" (click)="openReplyModal()">Ajouter ton Offre</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- ... rest of your code ... -->
<div class="card">
  <div class="card-body p-4">
    <div *ngIf="isCurrentUserOwner()">
      <h3>Les Réponses reçues à votre appel d'offre</h3>
      <div *ngIf="offerDetails?.replies && offerDetails.replies.length > 0">
        <table class="table align-middle table-nowrap">
          <thead>
            <tr>
              <th>L'Entreprise</th>
              <th>Date</th>
              <th>Fichier  </th>
              <th>Etat de l'offre</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let reply of offerDetails.replies">
              <td>{{ reply.user.name | uppercase }}</td>
              <td>{{ formatDate(reply.datereply) }}</td>
              <td>
                <ng-container *ngIf="isImage(reply.filePath); then imageContent; else pdfContent"></ng-container>
                <ng-template #imageContent>
                  <a [href]="reply.filePath" target="_blank" class="btn btn-primary mt-2" download="file">Télécharger l'image</a>
                </ng-template>
                <ng-template #pdfContent>
                  <a [href]="reply.filePath" target="_blank" class="btn btn-primary mt-2" download="file">Télécharger le PDF</a>
                </ng-template>
              </td>
              <td>{{ reply.etat }}</td>
              <td>
                <button type="button" class="btn btn-success mr-2" (click)="acceptReply()">Accepter</button>
                <button type="button" class="btn btn-danger" (click)="refuseReply(reply.id)">Refuser</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="offerDetails?.replies && offerDetails.replies.length === 0">
        <p>Aucune réponse pour le moment.</p>
      </div>
    </div>
  </div>
</div>

    <div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header d-flex flex-wrap align-items-center gap-3 mb-2">
        <div class="flex-shrink-0">
        </div>
        <div class="flex-shrink-0">
          <!-- <button type="button" class="btn btn-primary" (click)="addReply.show()"><i class="ph-plus-circle align-middle me-1"></i> Add Reply
        </div>
      </div>
</div><!--end row-->
<!-- addReview Modal -->
<div bsModal #addReview="bs-modal" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="addReviewLabel">Add Review</h1>
        <button type="button" class="btn-close" id="review-close" (click)="addReview.hide()"></button>
      </div>
      <form (ngSubmit)="saveReview()" [formGroup]="reviewForm" class="tablelist-form" novalidate autocomplete="off">
        <div class="modal-body">
          <div id="alert-error-msg" class="d-none alert alert-danger py-2"></div>
          <input type="hidden" id="id-field">
          <div class="mb-3">
            <label class="form-label d-block">Select Review <span class="text-danger">*</span></label>
            <div id="basic-rater" dir="ltr">
              <rating style="color: #f6b749;font-size: 25px;" formControlName="rate" [max]="5" [readonly]="false"></rating>
            </div>
          </div>
          <div class="mb-3">
            <label for="reviewTitle-input" class="form-label">Review Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" formControlName="title" id="reviewTitle-input" placeholder="Title" required>
          </div>
          <div class="mb-3">
            <label for="reviewDesc-input" class="form-label">Review <span class="text-danger">*</span></label>
            <textarea class="form-control" id="reviewDesc-input" formControlName="content" rows="4" placeholder="Enter review" required></textarea>
          </div>
          <div>
            <label class="form-label">Product Images</label>
            <dropzone class="dropzone" [config]="dropzoneConfig" [message]="'Drop files here or click to upload.'" (success)="onUploadSuccess($event)"></dropzone>

            @if (uploadedFiles) {
            <ul class="list-unstyled mb-0" id="dropzone-preview">
                @for (file of uploadedFiles; track $index) {
            <li class="mt-2" id="dropzone-preview-list">
              <div class="border rounded">
                <div class="d-flex p-2">
                  <div class="flex-shrink-0 me-3">
                    <div class="avatar-sm bg-light rounded p-2">
                      @if (file.dataURL) {
                      <img class="img-fluid rounded d-block" [src]="file.dataURL" alt="Dropzone-Image" />
                      }@else{
                      <img class="img-fluid rounded d-block" [src]="file" alt="Dropzone-Image" />
                      }
                    </div>
                  </div>
                  <div class="flex-grow-1">
                    <div class="pt-1">
                      @if (file.name) {<h5 class="fs-md mb-1">{{ file.name }}</h5>}
                      @if (file.size) {<p class="fs-sm text-muted mb-0">{{ file.size }}</p>}
                    </div>
                  </div>
                  <div class="flex-shrink-0 ms-3">
                    <button (click)="removeFile(file)" class="btn btn-sm btn-danger">Delete</button>
                  </div>
                </div>
              </div>
            </li>
            }
            </ul>
            }
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost-danger" (click)="addReview.hide()"><i class="ph-x align-middle me-1"></i> Close</button>
          <button type="submit" class="btn btn-primary">Add Review</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- removeItemModal -->
<div bsModal #removeItemModal="bs-modal" id="removeItemModal" class="modal fade zoomIn">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close" (click)="removeItemModal.hide()"></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <div class="text-danger">
            <i class="bi bi-trash display-4"></i>
          </div>
          <div class="mt-4 fs-base">
            <h4 class="mb-1">Are you sure ?</h4>
            <p class="text-muted mx-4 mb-0">Are you sure you want to remove this product?</p>
          </div>
        </div>
        <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
          <button type="button" class="btn w-sm btn-light" (click)="removeItemModal.hide()">Close</button>
          <button type="button" class="btn w-sm btn-danger" id="remove-product" (click)="deleteProduct()">Yes, Delete It!</button>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<ng-template #editOfferModalTemplate>
  <div class="modal-header">
    <h1 class="modal-title fs-5">Modifier Votre Appel d'Offer</h1>
    <button type="button" class="btn-close" (click)="editModalRef?.hide()"></button>
  </div>
  <div class="modal-body">
    <!-- Your form to edit offer details -->
    <div class="mb-3">
      <label for="title-input" class="form-label">Title</label>
      <input type="text" class="form-control" id="title-input" [(ngModel)]="editedOffer.title">
    </div>
    <div class="mb-3">
      <label for="title-input" class="form-label">Description</label>
      <input type="text" class="form-control" id="description-input" [(ngModel)]="editedOffer.description">
    </div>
    <!-- Add other form fields here -->
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="editModalRef?.hide()">Close</button>
    <button type="button" class="btn btn-primary" (click)="saveEditedOffer()">Save changes</button>
  </div>
</ng-template>
<!-- addReply Modal -->
          <!-- addReply Modal -->
          <div bsModal #addReply="bs-modal" class="modal fade">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="addReplyLabel">Ajouter une réponse</h1>
                  <button type="button" class="btn-close" (click)="addReply.hide()"></button>
                </div>
                <form [formGroup]="replyForm" (ngSubmit)="currentUserId && createReply(currentUserId, offerId, replyForm.value, uploadedReplyFiles[0])">
                  <div id="alert-error-msg" class="d-none alert alert-danger py-2"></div>
                  <input type="hidden" id="id-field">
                  <div class="mb-3">
                    <label for="text" class="form-label">Texte de la réponse <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="text" formControlName="text" rows="4" placeholder="Entrez votre réponse" required></textarea>
                    <div *ngIf="replyForm.controls['text'].invalid && replyForm.controls['text'].touched" class="text-danger">
                      Ce champ est obligatoire
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Joindre un fichier</label>
                    <input type="file" #fileInput id="filePath" (change)="onUploadSuccess($event)" formControlName="filePath" class="form-control">
                    <div class="progress mt-3" *ngIf="uploadProgress > 0 && uploadProgress < 100">
                      <div class="progress-bar" role="progressbar" [attr.aria-valuenow]="uploadProgress" aria-valuemin="0" aria-valuemax="100" [style.width.%]="uploadProgress"></div>
                    </div>
                    <div class="mb-3" *ngIf="uploadedImage">
                      <div class="uploaded-image-container d-flex align-items-center">
                        <img [src]="uploadedImage" alt="Uploaded Image" class="img-fluid me-2">
                        <p class="mb-0">{{ uploadedImageName }}</p>
                        <button type="button" class="btn btn-danger ms-auto" (click)="removeUploadedImage()">Supprimer</button>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-ghost-danger" (click)="addReply.hide()">
                      <i class="ph-x align-middle me-1"></i> Fermer
                    </button>
                    <button type="submit" class="btn btn-primary">Ajouter la réponse</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
